<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REST-запросы к Битрикс24</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        textarea {
            width: 100%;
            height: 150px;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>REST-запросы к Битрикс24</h1>
        <button id="authButton">Авторизоваться</button>
        <div id="result"></div>
    </div>

    <script>
        // Ваши данные приложения
        const clientId = 'local.672c46becf38c4.65238001';
        const clientSecret = 'zjA117Ud58UOayB6Gfu9qoCpmlGHdOQABImFDSDfqnpn1nd0WM';
        const redirectUri = 'https://ckenmuk.github.io/'; // Укажите ваш URL
        const portalUrl = 'https://rinecogroup.bitrix24.ru';

        // Элементы DOM
        const authButton = document.getElementById('authButton');
        const resultDiv = document.getElementById('result');

        // Шаг 1: Авторизация
        authButton.addEventListener('click', () => {
            const authUrl = `${portalUrl}/oauth/authorize/?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}`;
            window.location.href = authUrl;
        });

        // Шаг 2: Получение access_token
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            getAccessToken(code);
        }

        async function getAccessToken(code) {
            const tokenUrl = `${portalUrl}/oauth/token/?grant_type=authorization_code&client_id=${clientId}&client_secret=${clientSecret}&code=${code}&redirect_uri=${redirectUri}`;

            try {
                const response = await fetch(tokenUrl);
                const data = await response.json();

                if (data.access_token) {
                    resultDiv.innerHTML = '<p>Авторизация успешна!</p>';
                    // Выполнение REST-запроса
                    makeRestRequest(data.access_token);
                } else {
                    resultDiv.innerHTML = `<p>Ошибка: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p>Ошибка: ${error.message}</p>`;
            }
        }

        // Шаг 3: Выполнение REST-запроса
        async function makeRestRequest(accessToken) {
            const method = 'tasks.task.add'; // Пример метода API
            const params = {
                fields: {
                    TITLE: "Новая задача",
                    DESCRIPTION: "Описание задачи",
                    RESPONSIBLE_ID: 1
                }
            };

            const restUrl = `${portalUrl}/rest/1/${accessToken}/${method}`;

            try {
                const response = await fetch(restUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();
                resultDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            } catch (error) {
                resultDiv.innerHTML += `<p>Ошибка при выполнении запроса: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
